<!DOCTYPE html>
<html>
<head>
    <title>Constellation</title>
    <meta charset="utf-8"/>
    <link rel="icon" href="images/favicon.ico">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="third_party/leaflet/leaflet.css"/>
    <script src="third_party/leaflet/leaflet.js"></script>
    <script src="third_party/leaflet-heat.js"></script>
    <script src="third_party/reqwest.min.js"></script>
</head>
<body>

<div id="map">
    <div id="wrapper">
        <select id="repos" onchange="main(event);"></select>
    </div>
</div>

<script>
    reqwest({
        method: 'GET',
        type: 'json',
        url: 'data/contents.json'
    }).then(function (data) {
        var select = document.getElementById('repos');
        for (var i = 0; i < data.length; i++) {
            select.options[select.options.length] = new Option(data[i], 'data/' + data[i] + '.json');
        }
        select.selectedIndex = -1;
    }).fail(function (err) {
        console.error(err);
    });
</script>

<script>
    var map = L.map('map', {
        maxBounds: [
            [90, 180],
            [-90, -180]
        ],
        zoomControl: false,
        minZoom: 2,
        maxZoom: 15
    }).setView([55.796941, 37.537688], 3);

    new L.Control.Zoom({position: 'topright'}).addTo(map);

    L.tileLayer('http://otile{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpg', {
        attribution: 'Data, imagery and map information provided by MapQuest, <a href="http://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> and contributors, <a href="http://wiki.openstreetmap.org/wiki/Legal_FAQ#3a._I_would_like_to_use_OpenStreetMap_maps._How_should_I_credit_you.3F" target="_blank">ODbL</a>',
        maxZoom: 19,
        noWrap: true,
        subdomains: '1234'
    }).addTo(map);

    var heat;

    function main(e) {
        if (heat) {
            map.removeLayer(heat);
        }
        reqwest({
            method: 'GET',
            type: 'json',
            url: e.target.value
        }).then(function (data) {
            var out = [];
            for (var key in data) {
                if (data.hasOwnProperty(key)) {
                    out.push(data[key]);
                }
            }
            heat = L.heatLayer(out, {
                minOpacity: 0.4,
                radius: 15
            }).addTo(map);
        }).fail(function (err) {
            console.error(err);
        });
    }
</script>

<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-56786183-2', 'auto');
    ga('send', 'pageview');
</script>

</body>
</html>
